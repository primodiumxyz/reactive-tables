diff --git a/dist/index.js b/dist/index.js
index a3b068bdfd6ae862bc3fcbdb30e92aadee473fd6..8f7d178b736547f68d54df4137721b7647c8d753 100644
--- a/dist/index.js
+++ b/dist/index.js
@@ -1,3 +1,3 @@
 import{EventEmitter as K}from"eventemitter3";function S(e){return e&&typeof e.blockNumber=="string"&&Array.isArray(e.logs)&&typeof e.chunk=="number"&&typeof e.totalChunks=="number"}var I=e=>o=>e.some(n=>n.tableId===o.args.tableId&&(n.key0==null||n.key0===o.args.keyTuple[0])&&(n.key1==null||n.key1===o.args.keyTuple[1]));async function*k(e){let o=await fetch(e);if(!o.ok)throw new Error(`HTTP error! Status: ${o.status}`);let n=o.body?.getReader(),r=new TextDecoder,s="",t,i;if(!n){console.error("No reader found on response body while processing JSON stream");return}for(;{done:t,value:i}=await n.read(),!t;){let a=r.decode(i,{stream:!0});a=s+a;let c=a.split(`
-`);s=c.pop();for(let m of c)m&&(yield JSON.parse(m))}}var w=e=>{let{indexerUrl:o,filter:n}=e;return{subscribe:(r,s)=>{let t=new K;return t.on("update",r),s&&t.on("error",s),(async()=>{try{let i=encodeURIComponent(JSON.stringify(n)),a=`${o}/api/logs?input=${i}`;for await(let c of k(a)){if(!S(c)){t.emit("update",{blockNumber:0n,logs:[],progress:1});return}t.emit("update",{blockNumber:BigInt(c.blockNumber),logs:c.logs,progress:c.chunk/c.totalChunks})}}catch(i){t.emit("error",i)}finally{t.removeAllListeners("update"),t.removeAllListeners("error")}})(),()=>{t.removeAllListeners("update"),t.removeAllListeners("error")}}}};import{EventEmitter as z}from"eventemitter3";import{z as l}from"zod";import{isHex as b}from"viem";var he=l.object({address:l.string().refine(b).optional(),filters:l.array(l.object({tableId:l.string().refine(b),key0:l.string().refine(b).optional(),key1:l.string().refine(b).optional()})).default([])}),J=l.array(l.object({tableId:l.string().refine(b),on:l.string().default("__key_bytes")})),L=l.object({column:l.coerce.string(),operation:l.enum(["eq","neq","lt","lte","gt","gte"]),value:l.coerce.string()}),U=l.object({tableId:l.string().refine(b),where:L.optional(),and:L.array().optional(),or:L.array().optional(),include:J.optional()}).refine(e=>["where","and","or"].filter(r=>e[r]!==void 0).length<=1,{message:"Only one of 'where', 'and', or 'or' can be defined at a time",path:["where","and","or"]}),E=l.object({address:l.string().refine(b),queries:l.array(U)});var B=e=>{let{indexerUrl:o,query:n}=e;return{subscribe:(r,s)=>{let t=new z;return t.on("update",r),s&&t.on("error",s),(async()=>{try{let i=E.parse(n),a=encodeURIComponent(JSON.stringify(i)),c=`${o}/api/queryLogs?&input=${a}`;for await(let m of k(c)){if(!S(m)){t.emit("update",{blockNumber:0n,logs:[],progress:1});return}t.emit("update",{blockNumber:BigInt(m.blockNumber),progress:m.chunk/m.totalChunks,logs:m.logs})}}catch(i){t.emit("error",i)}finally{t.removeAllListeners("update"),t.removeAllListeners("error")}})(),()=>{t.removeAllListeners("update"),t.removeAllListeners("error")}}}};import{EventEmitter as G}from"eventemitter3";import{fetchLogs as X}from"@latticexyz/block-logs-stream";import{storeEventsAbi as Y}from"@latticexyz/store";function C(e){return{subscribe:(o,n)=>{let r=new G;return r.on("update",o),n&&r.on("error",n),(async()=>{try{for await(let{logs:s,toBlock:t}of X({events:Y,fromBlock:e.fromBlock,address:e.address,toBlock:e.toBlock,publicClient:e.publicClient,maxBlockRange:e.maxBlockRange})){let i=Number(t-e.fromBlock),a=Number(e.toBlock-e.fromBlock);r.emit("update",{blockNumber:t,logs:s,progress:a?i/a:1})}}catch(s){r.emit("error",s)}finally{r.removeAllListeners("update"),r.removeAllListeners("error")}})(),()=>{r.removeAllListeners("update"),r.removeAllListeners("error")}}}}import{groupLogsByBlockNumber as Z}from"@latticexyz/block-logs-stream";import{storeEventsAbi as ee}from"@latticexyz/store";import{debug as _}from"debug";var d=_("primodium:sync-stack"),A=_("primodium:sync-stack");d.log=console.debug.bind(console);A.log=console.error.bind(console);var f=new Map,R=new Map;function re(e,o,n){let r=f.get(e);if(!r)return-1;let s=r.length;return r.push({id:s,filter:o,callback:n}),d(`sub event - client: ${e.name}, id: ${s}, subs: ${r.length}`),s}function te(e,o){let n=f.get(e);if(n){if(n.length===1){d(`unsub event - client: ${e.name}, id: ${o}, subs: ${n.length-1}`),d("no listeners, unsubscribing from watch event"),R.get(e)?.(),f.delete(e),R.delete(e);return}f.set(e,n.filter(r=>r.id!==o)),d(`unsub event - client: ${e.name}, id: ${o}, subs: ${n.length-1}`)}}function oe(e){let{publicClient:o,address:n}=e;f.set(o,[]);let r=o.watchEvent({onLogs:s=>{let t=f.get(o);if(!t===void 0){A("could not find public client");return}if(t?.length===0){d("no listeners, unsubscribing from watch event"),r(),f.delete(o),R.delete(o);return}t?.forEach(({filter:i,callback:a})=>{let c=i?s.filter(I(i)):s,m=Z(c);d(`client: ${o.name}, subs: ${t.length}: logs: ${s.length}, filteredLogs: ${c.length}, blocks: ${m.length}`);for(let u of m)a(u)})},events:ee,address:n,strict:!0});R.set(o,r)}function N(e){return f.has(e.publicClient)||oe(e),{subscribe:o=>{let n=re(e.publicClient,e.logFilter,o);return()=>te(e.publicClient,n)}}}var h={fromDecodedIndexer:{filter:w,query:B},fromIndexer:{filter:w},fromRPC:{filter:C,subscribe:N}};function g(e){return o=>{switch(o.eventName){case"Store_SetRecord":d("setting new record in store"),e.set(o);break;case"Store_SpliceStaticData":d("updating static data record in store"),e.updateStatic(o);break;case"Store_SpliceDynamicData":d("updating dynamic data record in store"),e.updateDynamic(o);break;case"Store_DeleteRecord":d("deleting record in store"),e.delete(o);break;default:d("unknown event");break}}}var $=g({delete(e){console.log("delete",e)},set(e){console.log("set",e)},updateDynamic(e){console.log("updateDynamic",e)},updateStatic(e){console.log("updateStatic",e)}});import{hexToResource as ce,spliceHex as F}from"@latticexyz/common";import{getComponentValue as T,removeComponent as ie,setComponent as P}from"@latticexyz/recs";import{decodeValueArgs as D}from"@latticexyz/protocol-parser/internal";import{size as me}from"viem";import{mapObject as se}from"@latticexyz/common/utils";import{stringToHex as Je,encodeAbiParameters as Ue,concatHex as ae}from"viem";function W(e){return ae(e)}function v(e){return se(e,o=>o.type)}var O=({world:e,tables:o})=>{function n(r){let{namespace:s,name:t}=ce(r.args.tableId),i=e.components.find(u=>u.id===r.args.tableId),a=Object.keys(o).find(u=>o[u].tableId===r.args.tableId),c=a?o[a]:void 0;if(!i){d(`unknown component: ${r.args.tableId} (${s}:${t})`);return}if(!c){d(`skipping update for unknown table: ${s}:${t} at ${r.address}`);return}return{entity:W(r.args.keyTuple),component:i,table:c}}return g({set(r){let s=n(r);if(!s)return;let{entity:t,component:i,table:a}=s,c=D(v(a.valueSchema),r.args);d("setting component",{namespace:a.namespace,name:a.name,entity:t,value:c}),P(i,t,{...c,__staticData:r.args.staticData,__encodedLengths:r.args.encodedLengths,__dynamicData:r.args.dynamicData})},updateStatic(r){let s=n(r);if(!s)return;let{entity:t,component:i,table:a}=s,c=T(i,t),m=c?.__staticData??"0x",u=F(m,r.args.start,me(r.args.data),r.args.data),p=D(v(a.valueSchema),{staticData:u,encodedLengths:c?.__encodedLengths??"0x",dynamicData:c?.__dynamicData??"0x"});d("setting component via splice static",{namespace:a.namespace,name:a.name,entity:t,previousStaticData:m,newStaticData:u,previousValue:c,newValue:p}),P(i,t,{...p,__staticData:u})},updateDynamic(r){let s=n(r);if(!s)return;let{entity:t,component:i,table:a}=s,c=T(i,t),m=c?.__dynamicData??"0x",u=F(m,r.args.start,r.args.deleteCount,r.args.data),p=D(v(a.valueSchema),{staticData:c?.__staticData??"0x",encodedLengths:r.args.encodedLengths,dynamicData:u});d("setting component via splice dynamic",{namespace:a.namespace,name:a.name,entity:t,previousDynamicData:m,newDynamicData:u,previousValue:c,newValue:p}),P(i,t,{...p,__encodedLengths:r.args.encodedLengths,__dynamicData:u})},delete(r){let s=n(r);if(!s)return;let{entity:t,component:i,table:a}=s;d("deleting component",{namespace:a.namespace,name:a.name,entity:t}),ie(i,t)}})};var x={toCustom:g,toConsole:$,toRecs:O};function y(e){let{reader:o,writer:n}=e,r=[];return{start:(t,i)=>{function a(c,m){t&&t(m,0n,0),r.push(c.subscribe(u=>{for(let p of u.logs)Array.isArray(n)?n.forEach(V=>V(p)):n(p);t&&t(m,u.blockNumber,u.progress??1)},i))}Array.isArray(o)?o.forEach((c,m)=>a(c,m)):a(o,0)},unsubscribe:()=>{r.forEach(t=>{t()})}}}function H(e){let{world:o,tables:n,address:r,logFilter:s,publicClient:t}=e;return y({reader:h.fromRPC.subscribe({address:r,publicClient:t,logFilter:s}),writer:x.toRecs({world:o,tables:n})})}function j(e){let{world:o,tables:n,address:r,filter:s,publicClient:t,fromBlock:i,toBlock:a,maxBlockRange:c,maxRetryCount:m}=e;return y({reader:h.fromRPC.filter({address:r,publicClient:t,filter:s,fromBlock:i,toBlock:a,maxBlockRange:c,maxRetryCount:m}),writer:x.toRecs({world:o,tables:n})})}function q(e){let{world:o,tables:n,filter:r,indexerUrl:s}=e;return y({reader:h.fromIndexer.filter({filter:r,indexerUrl:s}),writer:x.toRecs({world:o,tables:n})})}var Q=e=>{let{world:o,tables:n,indexerUrl:r,query:s}=e;return y({reader:h.fromDecodedIndexer.query({indexerUrl:r,query:s}),writer:x.toRecs({world:o,tables:n})})};var yr={withCustom:y,withLiveRPCRecsSync:H,withRPCRecsSync:j,withFilterIndexerRecsSync:q,withQueryDecodedIndexerRecsSync:Q};export{h as Read,yr as Sync,x as Write};
+`);s=c.pop();for(let m of c)m&&(yield JSON.parse(m))}}var w=e=>{let{indexerUrl:o,filter:n}=e;return{subscribe:(r,s)=>{let t=new K;return t.on("update",r),s&&t.on("error",s),(async()=>{try{let i=encodeURIComponent(JSON.stringify(n)),a=`${o}/api/logs?input=${i}`;for await(let c of k(a)){if(!S(c)){t.emit("update",{blockNumber:0n,logs:[],progress:1});return}t.emit("update",{blockNumber:BigInt(c.blockNumber),logs:c.logs,progress:c.chunk/c.totalChunks})}}catch(i){t.emit("error",i)}finally{t.removeAllListeners("update"),t.removeAllListeners("error")}})(),()=>{t.removeAllListeners("update"),t.removeAllListeners("error")}}}};import{EventEmitter as z}from"eventemitter3";import{z as l}from"zod";import{isHex as b}from"viem";var he=l.object({address:l.string().refine(b).optional(),filters:l.array(l.object({tableId:l.string().refine(b),key0:l.string().refine(b).optional(),key1:l.string().refine(b).optional()})).default([])}),J=l.array(l.object({tableId:l.string().refine(b),on:l.string().default("__key_bytes")})),L=l.object({column:l.coerce.string(),operation:l.enum(["eq","neq","lt","lte","gt","gte"]),value:l.coerce.string()}),U=l.object({tableId:l.string().refine(b),where:L.optional(),and:L.array().optional(),or:L.array().optional(),include:J.optional()}).refine(e=>["where","and","or"].filter(r=>e[r]!==void 0).length<=1,{message:"Only one of 'where', 'and', or 'or' can be defined at a time",path:["where","and","or"]}),E=l.object({address:l.string().refine(b),queries:l.array(U)});var B=e=>{let{indexerUrl:o,query:n}=e;return{subscribe:(r,s)=>{let t=new z;return t.on("update",r),s&&t.on("error",s),(async()=>{try{let i=E.parse(n),a=encodeURIComponent(JSON.stringify(i)),c=`${o}/api/queryLogs?&input=${a}`;for await(let m of k(c)){if(!S(m)){t.emit("update",{blockNumber:0n,logs:[],progress:1});return}t.emit("update",{blockNumber:BigInt(m.blockNumber),progress:m.chunk/m.totalChunks,logs:m.logs})}}catch(i){t.emit("error",i)}finally{t.removeAllListeners("update"),t.removeAllListeners("error")}})(),()=>{t.removeAllListeners("update"),t.removeAllListeners("error")}}}};import{EventEmitter as G}from"eventemitter3";import{fetchLogs as X}from"@latticexyz/block-logs-stream";import{storeEventsAbi as Y}from"@latticexyz/store";function C(e){return{subscribe:(o,n)=>{let r=new G;return r.on("update",o),n&&r.on("error",n),(async()=>{try{for await(let{logs:s,toBlock:t}of X({events:Y,fromBlock:e.fromBlock,address:e.address,toBlock:e.toBlock,publicClient:e.publicClient,maxBlockRange:e.maxBlockRange})){let i=Number(t-e.fromBlock),a=Number(e.toBlock-e.fromBlock);r.emit("update",{blockNumber:t,logs:s,progress:a?i/a:1})}}catch(s){r.emit("error",s)}finally{r.removeAllListeners("update"),r.removeAllListeners("error")}})(),()=>{r.removeAllListeners("update"),r.removeAllListeners("error")}}}}import{groupLogsByBlockNumber as Z}from"@latticexyz/block-logs-stream";import{storeEventsAbi as ee}from"@latticexyz/store";import _ from"debug";var d=_("primodium:sync-stack"),A=_("primodium:sync-stack");d.log=console.debug.bind(console);A.log=console.error.bind(console);var f=new Map,R=new Map;function re(e,o,n){let r=f.get(e);if(!r)return-1;let s=r.length;return r.push({id:s,filter:o,callback:n}),d(`sub event - client: ${e.name}, id: ${s}, subs: ${r.length}`),s}function te(e,o){let n=f.get(e);if(n){if(n.length===1){d(`unsub event - client: ${e.name}, id: ${o}, subs: ${n.length-1}`),d("no listeners, unsubscribing from watch event"),R.get(e)?.(),f.delete(e),R.delete(e);return}f.set(e,n.filter(r=>r.id!==o)),d(`unsub event - client: ${e.name}, id: ${o}, subs: ${n.length-1}`)}}function oe(e){let{publicClient:o,address:n}=e;f.set(o,[]);let r=o.watchEvent({onLogs:s=>{let t=f.get(o);if(!t===void 0){A("could not find public client");return}if(t?.length===0){d("no listeners, unsubscribing from watch event"),r(),f.delete(o),R.delete(o);return}t?.forEach(({filter:i,callback:a})=>{let c=i?s.filter(I(i)):s,m=Z(c);d(`client: ${o.name}, subs: ${t.length}: logs: ${s.length}, filteredLogs: ${c.length}, blocks: ${m.length}`);for(let u of m)a(u)})},events:ee,address:n,strict:!0});R.set(o,r)}function N(e){return f.has(e.publicClient)||oe(e),{subscribe:o=>{let n=re(e.publicClient,e.logFilter,o);return()=>te(e.publicClient,n)}}}var h={fromDecodedIndexer:{filter:w,query:B},fromIndexer:{filter:w},fromRPC:{filter:C,subscribe:N}};function g(e){return o=>{switch(o.eventName){case"Store_SetRecord":d("setting new record in store"),e.set(o);break;case"Store_SpliceStaticData":d("updating static data record in store"),e.updateStatic(o);break;case"Store_SpliceDynamicData":d("updating dynamic data record in store"),e.updateDynamic(o);break;case"Store_DeleteRecord":d("deleting record in store"),e.delete(o);break;default:d("unknown event");break}}}var $=g({delete(e){console.log("delete",e)},set(e){console.log("set",e)},updateDynamic(e){console.log("updateDynamic",e)},updateStatic(e){console.log("updateStatic",e)}});import{hexToResource as ce,spliceHex as F}from"@latticexyz/common";import{getComponentValue as T,removeComponent as ie,setComponent as P}from"@latticexyz/recs";import{decodeValueArgs as D}from"@latticexyz/protocol-parser/internal";import{size as me}from"viem";import{mapObject as se}from"@latticexyz/common/utils";import{stringToHex as Je,encodeAbiParameters as Ue,concatHex as ae}from"viem";function W(e){return ae(e)}function v(e){return se(e,o=>o.type)}var O=({world:e,tables:o})=>{function n(r){let{namespace:s,name:t}=ce(r.args.tableId),i=e.components.find(u=>u.id===r.args.tableId),a=Object.keys(o).find(u=>o[u].tableId===r.args.tableId),c=a?o[a]:void 0;if(!i){d(`unknown component: ${r.args.tableId} (${s}:${t})`);return}if(!c){d(`skipping update for unknown table: ${s}:${t} at ${r.address}`);return}return{entity:W(r.args.keyTuple),component:i,table:c}}return g({set(r){let s=n(r);if(!s)return;let{entity:t,component:i,table:a}=s,c=D(v(a.valueSchema),r.args);d("setting component",{namespace:a.namespace,name:a.name,entity:t,value:c}),P(i,t,{...c,__staticData:r.args.staticData,__encodedLengths:r.args.encodedLengths,__dynamicData:r.args.dynamicData})},updateStatic(r){let s=n(r);if(!s)return;let{entity:t,component:i,table:a}=s,c=T(i,t),m=c?.__staticData??"0x",u=F(m,r.args.start,me(r.args.data),r.args.data),p=D(v(a.valueSchema),{staticData:u,encodedLengths:c?.__encodedLengths??"0x",dynamicData:c?.__dynamicData??"0x"});d("setting component via splice static",{namespace:a.namespace,name:a.name,entity:t,previousStaticData:m,newStaticData:u,previousValue:c,newValue:p}),P(i,t,{...p,__staticData:u})},updateDynamic(r){let s=n(r);if(!s)return;let{entity:t,component:i,table:a}=s,c=T(i,t),m=c?.__dynamicData??"0x",u=F(m,r.args.start,r.args.deleteCount,r.args.data),p=D(v(a.valueSchema),{staticData:c?.__staticData??"0x",encodedLengths:r.args.encodedLengths,dynamicData:u});d("setting component via splice dynamic",{namespace:a.namespace,name:a.name,entity:t,previousDynamicData:m,newDynamicData:u,previousValue:c,newValue:p}),P(i,t,{...p,__encodedLengths:r.args.encodedLengths,__dynamicData:u})},delete(r){let s=n(r);if(!s)return;let{entity:t,component:i,table:a}=s;d("deleting component",{namespace:a.namespace,name:a.name,entity:t}),ie(i,t)}})};var x={toCustom:g,toConsole:$,toRecs:O};function y(e){let{reader:o,writer:n}=e,r=[];return{start:(t,i)=>{function a(c,m){t&&t(m,0n,0),r.push(c.subscribe(u=>{for(let p of u.logs)Array.isArray(n)?n.forEach(V=>V(p)):n(p);t&&t(m,u.blockNumber,u.progress??1)},i))}Array.isArray(o)?o.forEach((c,m)=>a(c,m)):a(o,0)},unsubscribe:()=>{r.forEach(t=>{t()})}}}function H(e){let{world:o,tables:n,address:r,logFilter:s,publicClient:t}=e;return y({reader:h.fromRPC.subscribe({address:r,publicClient:t,logFilter:s}),writer:x.toRecs({world:o,tables:n})})}function j(e){let{world:o,tables:n,address:r,filter:s,publicClient:t,fromBlock:i,toBlock:a,maxBlockRange:c,maxRetryCount:m}=e;return y({reader:h.fromRPC.filter({address:r,publicClient:t,filter:s,fromBlock:i,toBlock:a,maxBlockRange:c,maxRetryCount:m}),writer:x.toRecs({world:o,tables:n})})}function q(e){let{world:o,tables:n,filter:r,indexerUrl:s}=e;return y({reader:h.fromIndexer.filter({filter:r,indexerUrl:s}),writer:x.toRecs({world:o,tables:n})})}var Q=e=>{let{world:o,tables:n,indexerUrl:r,query:s}=e;return y({reader:h.fromDecodedIndexer.query({indexerUrl:r,query:s}),writer:x.toRecs({world:o,tables:n})})};var yr={withCustom:y,withLiveRPCRecsSync:H,withRPCRecsSync:j,withFilterIndexerRecsSync:q,withQueryDecodedIndexerRecsSync:Q};export{h as Read,yr as Sync,x as Write};
 //# sourceMappingURL=index.js.map
